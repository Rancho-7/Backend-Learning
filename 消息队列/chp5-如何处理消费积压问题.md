在我们的日常生产中，可能会遇到消息积压的问题。其出现的直接原因就是系统中的某个部分出现了性能问题，使得下游来不及处理上游发送的消息，从而导致消息积压。

为了解决消息积压的问题，我们可以从以下两个方面进行处理：

- **优化性能避免消息积压**
- **消息积压后进行紧急处理**

#### 一、优化性能避免消息积压

如果我们要对使用消息队列的系统进行优化，应该将重点放在生产者和消费者这两部分的业务逻辑中，而不用去过多的关注消息队列的服务端。这是因为**消息队列本身的处理能力要远大于业务系统的处理能力**。

因此我们需要在消息的收发端将业务代码和消息队列进行配合，达到最佳的性能。

**1.消息发送端性能优化**

如果我们发送消息的性能上不去，多半是因为**发送消息的业务逻辑太耗时导致的**。对此我们只需要设置**合适的并发和消息的批量大小**，就能达到很好的发送性能。

Producer和Broker交互时花费时间的步骤主要如下：

- Producer准备数据、序列化消息、构造请求等业务逻辑的时间；
- 消息在网络传输中的耗时（请求和响应）；
- Broker处理消息的时间；

对于采取**提高并发数**还是**增大消息量**的方式，主要根据业务系统进行选择。

如果是对**时延要求比较高**的在线系统，可以增加线程数来提高并发；

如果是对**时延要求比较低**的离线系统，可以批量发送消息，这样通过少量并发也能够提高吞吐量。

**2.消息接收端性能优化**

在使用消息队列时，大部分消息积压问题都出现在消费者。消费端消费消息的速度赶不上生产的速度，就会导致消息积压。

如果消费者过一段时间性能恢复，那么被积压的消息是可以被处理掉的。但如果长时间如此，就会导致消息的丢失甚至无法提供服务。因此，**我们要保证消费端的消费性能高于生产端的发送性能，这样才能保证系统的正常运行。**

对于消费端性能的提升，我们可以采取以下两点：

- **优化消费的业务逻辑**
- **水平扩容**

水平扩容时需要注意，**在扩容Consumer实例数量时，需要同步扩容主题中的队列（分区）数量，保证Consumer的实例数禾队列（分区）的数量相等。因为对于消费者来说，每个分区实际上只能支持单线程消费。**

#### 二、消息积压后的处理

首先我们需要知道是什么导致消息的积压，笼统的来说只有两种情况：要么**发送变快了**，要么**消费变慢了**。

大部分消息队列都内置了数据监控的功能，可以方便我们确定原因。

> 如果是**生产者发送的消息增多**（秒杀大促等），可以采取以下措施：

- 短时间无法优化消费端代码的情况下，通过扩容增加消费端的实例数；
- 无法扩容时，将系统降级，关闭一些不重要的业务，减少发送方的数据量；

> 如果发送和消费的**速度都没有变化**，可以采取以下措施：

- 这种情况下需要检查一下消费端，有可能是**消费失败导致一条消息反复消费**；

> 如果消费者**消费消息变慢**，可以采取以下措施：

- 检查日志是否有大量的消费错误；
- 如果没有错误可以打印堆栈信息，看消费线程是否卡住了（触发死锁或者等待某些资源）；